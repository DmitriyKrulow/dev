@model uchet.Models.Inventory

@{
    ViewData["Title"] = "Сканирование имущества";
}

<h2>Сканирование имущества</h2>

<div>
    <h4>Инвентаризация: @Model.Name</h4>
    <p><strong>Локация:</strong> @Model.Location?.Name</p>
    
    <div class="progress mb-3">
        <div class="progress-bar" role="progressbar" 
             style="width: @((Model.TotalItems > 0 ? (Model.CheckedItems * 100 / Model.TotalItems) : 0))%"
             aria-valuenow="@Model.CheckedItems" 
             aria-valuemin="0" 
             aria-valuemax="@Model.TotalItems">
            Прогресс: @Model.CheckedItems / @Model.TotalItems
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Сканирование QR кода или штрих-кода</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="codeInput">Введите код или используйте сканер:</label>
                    <input type="text" id="codeInput" class="form-control" placeholder="Введите QR код или инвентарный номер" />
                </div>
                <button id="checkButton" class="btn btn-primary mt-2">Проверить имущество</button>
                
                <!-- Интерфейс сканирования камерой -->
                <div class="mt-3">
                    <button id="startCameraButton" class="btn btn-info">Запустить камеру</button>
                    <button id="stopCameraButton" class="btn btn-secondary" style="display: none;">Остановить камеру</button>
                </div>
                <div id="cameraContainer" class="mt-2" style="display: none;">
                    <video id="video" width="100%" height="300" style="border: 1px solid #ccc;"></video>
                    <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Результат проверки</h5>
            </div>
            <div class="card-body">
                <div id="resultMessage"></div>
            </div>
        </div>
    </div>
</div>


<div class="mt-3">
    <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary">Назад к деталям</a>
</div>

@section Scripts {
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        $(document).ready(function() {
            // Добавляем логирование для диагностики загрузки свойств
            console.log('Загружаем список имущества...');
            // Загружаем список имущества при загрузке страницы
            // loadLocationProperties(); // Убираем дублирующий вызов
            
            $('#checkButton').click(function() {
                var code = $('#codeInput').val();
                if (!code) {
                    showMessage('Пожалуйста, введите код', 'danger');
                    return;
                }
                
                $.post('@Url.Action("CheckItem", "Inventory")', {
                    inventoryId: @Model.Id,
                    code: code
                }, function(data) {
                    if (data.success) {
                        showMessage(data.message, 'success');
                        $('#codeInput').val('');
                        
                        // Обновляем прогресс
                        var progressPercent = data.totalItems > 0 ? (data.checkedItems * 100 / data.totalItems) : 0;
                        $('.progress-bar').css('width', progressPercent + '%');
                        $('.progress-bar').attr('aria-valuenow', data.checkedItems);
                        $('.progress-bar').text('Прогресс: ' + data.checkedItems + ' / ' + data.totalItems);
                        
                        // Перезагружаем список имущества
                        loadLocationProperties();
                        
                        // Если инвентаризация завершена
                        if (data.isCompleted) {
                            setTimeout(function() {
                                window.location.href = '@Url.Action("Details", "Inventory", new { id = Model.Id })';
                            }, 2000);
                        }
                    } else {
                        showMessage(data.message, 'danger');
                    }
                }).fail(function() {
                    showMessage('Ошибка при проверке имущества', 'danger');
                });
            });
            
            // Обработка нажатия Enter в поле ввода
            $('#codeInput').keypress(function(e) {
                if (e.which === 13) {
                    $('#checkButton').click();
                }
            });
            
            function showMessage(text, type) {
                var alertClass = 'alert-' + type;
                var html = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                           text +
                           '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                           '</div>';
                $('#resultMessage').html(html);
            }
            
            // Загрузка списка имущества
            function loadLocationProperties() {
                // Добавляем логирование для диагностики загрузки свойств
                console.log('Загружаем список имущества...');
                
                $.get('@Url.Action("GetLocationProperties", "Inventory")', {
                    inventoryId: @Model.Id
                }, function(data) {
                    // Добавляем логирование для диагностики полученных данных
                    console.log('Получены данные:', data);
                    
                    if (data.success) {
                        // Добавляем логирование для диагностики отображения свойств
                        console.log('Отображаем свойства:', data.properties);
                        
                        var html = '<table class="table table-striped">' +
                                   '<thead><tr>' +
                                   '<th>Название</th>' +
                                   '<th>Тип</th>' +
                                   '<th>Инвентарный номер</th>' +
                                   '<th>Статус</th>' +
                                   '<th>Дата проверки</th>' +
                                   '</tr></thead><tbody>';
                                   
                        data.properties.forEach(function(property) {
                            // Добавляем логирование для диагностики отображения каждого свойства
                            console.log('Отображаем свойство:', property);
                            
                            var status = property.IsChecked ?
                                '<span class="badge bg-success">Проверено</span>' :
                                '<span class="badge bg-danger">Не проверено</span>';
                                
                            var checkDate = property.CheckDate ?
                                new Date(property.CheckDate).toLocaleDateString('ru-RU') :
                                '';
                                
                            html += '<tr>' +
                                    '<td>' + (property.Name || 'Не указано') + '</td>' +
                                    '<td>' + (property.PropertyTypeName || 'Не указан') + '</td>' +
                                    '<td>' + (property.InventoryNumber || 'Не указан') + '</td>' +
                                    '<td>' + status + '</td>' +
                                    '<td>' + checkDate + '</td>' +
                                    '</tr>';
                        });
                        
                        html += '</tbody></table>';
                        $('#propertiesList').html(html);
                    } else {
                        $('#propertiesList').html('<p>Ошибка загрузки имущества: ' + data.message + '</p>');
                    }
                }).fail(function() {
                    console.log('Ошибка загрузки имущества');
                    $('#propertiesList').html('<p>Ошибка загрузки имущества</p>');
                });
            }
            
            // Загружаем список имущества при загрузке страницы
            loadLocationProperties();
            
            // Инициализация сканера QR кодов
            let html5QrCode = new Html5Qrcode("video");
            let isScanning = false;
            
            $('#startCameraButton').click(function() {
                if (isScanning) return;
                
                $('#cameraContainer').show();
                $('#startCameraButton').hide();
                $('#stopCameraButton').show();
                
                html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    qrCodeMessage => {
                        // Обработка найденного QR кода
                        $('#codeInput').val(qrCodeMessage);
                        $('#checkButton').click();
                        
                        // Останавливаем сканер после успешного сканирования
                        stopCamera();
                    },
                    errorMessage => {
                        // Обработка ошибок сканирования
                    }
                ).catch(err => {
                    console.log(`Unable to start scanning, error: ${err}`);
                    showMessage('Не удалось запустить камеру: ' + err, 'danger');
                    stopCamera();
                });
                
                isScanning = true;
            });
            
            $('#stopCameraButton').click(function() {
                stopCamera();
            });
            
            function stopCamera() {
                if (isScanning) {
                    html5QrCode.stop().then(ignore => {
                        isScanning = false;
                        $('#cameraContainer').hide();
                        $('#startCameraButton').show();
                        $('#stopCameraButton').hide();
                    }).catch(err => {
                        console.log("Unable to stop camera");
                    });
                }
            }
            
            // Остановка камеры при закрытии страницы
            $(window).on('beforeunload', function() {
                if (isScanning) {
                    html5QrCode.stop().catch(err => {
                        console.log("Unable to stop camera");
                    });
                }
            });
        });
    </script>
}