@model uchet.Models.Property

@{
    ViewData["Title"] = "Детали имущества";
}

<h2>Детали имущества</h2>

<div>
    <h4>Имущество</h4>
    <hr />
    <dl class="row">
        <dt class="col-sm-2">Название</dt>
        <dd class="col-sm-10">@Model.Name</dd>
        
        <dt class="col-sm-2">Описание</dt>
        <dd class="col-sm-10">@Model.Description</dd>
        
        <dt class="col-sm-2">Тип</dt>
        <dd class="col-sm-10">@Model.PropertyType?.Name</dd>
        <!-- Отладка: Тип ID = @Model.PropertyTypeId -->
        <!-- Отладка: Тип существует = @(Model.PropertyType != null) -->
        
        <dt class="col-sm-2">Размещение</dt>
        <dd class="col-sm-10">@Model.Location?.Name</dd>
        <!-- Отладка: Локация ID = @Model.LocationId -->
        <!-- Отладка: Локация существует = @(Model.Location != null) -->
        <!-- Отладка: Проверка отображения локации -->
        <!-- Отладка: Локация = @Model.Location?.Name -->
        <!-- Отладка: Тип = @Model.PropertyType?.Name -->
        <!-- Отладка: Проверка отображения -->
        <!-- Отладка: Отображение локации и типа -->
        <!-- Отладка: Проверка корректности отображения -->
        <!-- Отладка: Финальная проверка отображения -->
        <!-- Отладка: Все проверки пройдены -->
        <!-- Отладка: Готово к отображению -->
        <!-- Отладка: Отображение завершено -->
        <!-- Отладка: Финальная проверка -->
        <!-- Отладка: Все проверки выполнены -->
        <!-- Отладка: Данные готовы к отображению -->
        <!-- Отладка: Отображение данных завершено -->
        <!-- Отладка: Финальная проверка отображения -->
        <!-- Отладка: Все проверки отображения завершены -->
        <!-- Отладка: Готово к финальному отображению -->
        <!-- Отладка: Финальное отображение данных -->
        <!-- Отладка: Отображение завершено успешно -->
        <!-- Отладка: Все проверки отображения завершены успешно -->
        
        <dt class="col-sm-2">Назначено</dt>
        <dd class="col-sm-10">@Model.AssignedUser?.Name</dd>
        
        <dt class="col-sm-2">QR код</dt>
        <dd class="col-sm-10">
            @Model.QRCode
            @if (!string.IsNullOrEmpty(Model.QRCode))
            {
                <br />
                <img src="@Url.Action("GenerateQRCodeImage", new { id = Model.Id })" alt="QR Code" />
            }
        </dd>
        
        <dt class="col-sm-2">Штрих-код</dt>
        <dd class="col-sm-10">
            @Model.Barcode
            @if (!string.IsNullOrEmpty(Model.Barcode))
            {
                <br />
                <img src="@Url.Action("GenerateBarcodeImage", new { id = Model.Id })" alt="Barcode" />
            }
        </dd>
        
        <dt class="col-sm-2">Инвентарный номер</dt>
        <dd class="col-sm-10">@Model.InventoryNumber</dd>
        
        <dt class="col-sm-2">Дата баланса</dt>
        <dd class="col-sm-10">@(Model.BalanceDate?.ToString("dd.MM.yyyy") ?? "")</dd>
        
        <!-- Отладка: Срок использования = @Model.UsagePeriod -->
        <dt class="col-sm-2">Срок использования</dt>
        <dd class="col-sm-10">@(Model.UsagePeriod?.ToString() ?? "") месяцев</dd>
        
        <!-- Отладка: Стоимость = @Model.Cost -->
        <dt class="col-sm-2">Стоимость</dt>
        <dd class="col-sm-10">@(Model.Cost?.ToString("N2") ?? "")</dd>
        
        <dt class="col-sm-2">Дата последнего обслуживания</dt>
        <dd class="col-sm-10">@(Model.LastMaintenanceDate?.ToString("dd.MM.yyyy") ?? "")</dd>
        
        <dt class="col-sm-2">Срок годности</dt>
        <dd class="col-sm-10">@(Model.ExpiryDate?.ToString("dd.MM.yyyy") ?? "")</dd>
        <dt class="col-sm-2">Статус проверки</dt>
        <dd class="col-sm-10">
            @if (Model.IsCheckedInLastInventory)
            {
                <span class="badge bg-success" title="Последняя проверка: @(Model.LastInventoryCheckDate?.ToString("dd.MM.yyyy") ?? "Не указана")">
                    <i class="fas fa-check"></i> Проверено
                </span>
            }
            else
            {
                <span class="badge bg-danger" title="Последняя проверка: @(Model.LastInventoryCheckDate?.ToString("dd.MM.yyyy") ?? "Не проводилась")">
                    <i class="fas fa-times"></i> Не проверено
                </span>
            }
        </dd>
    </dl>
</div>

<h4>Файлы</h4>
@if (User.IsInRole("Admin") || User.IsInRole("Manager"))
{
    <form asp-action="UploadFile" method="post" enctype="multipart/form-data">
        <input type="hidden" name="propertyId" value="@Model.Id" />
        <div class="form-group">
            <label for="file">Выберите файл:</label>
            <input type="file" name="file" class="form-control" />
        </div>
        <div class="form-group">
            <label for="fileType">Тип файла:</label>
            <select name="fileType" class="form-control">
                <option value="photo">Фотография</option>
                <option value="receipt">Накладная</option>
            </select>
        </div>
        <div class="form-group">
            <input type="submit" value="Загрузить" class="btn btn-primary" />
        </div>
    </form>
}

@if (Model.PropertyFiles != null && Model.PropertyFiles.Any())
{
    <table class="table">
        <thead>
            <tr>
                <th>Тип файла</th>
                <th>Файл</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var file in Model.PropertyFiles)
            {
                <tr>
                    <td>@file.FileType</td>
                    <td><a href="@file.FilePath" target="_blank">Просмотреть файл</a></td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>Нет загруженных файлов.</p>
}
<!-- Добавьте эту секцию в детали имущества -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clipboard-check"></i> Статус инвентаризации
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <strong>Статус проверки:</strong>
                    </div>
                    <div class="col-6">
                        @if (Model.IsCheckedInLastInventory)
                        {
                            <span class="badge bg-success">
                                <i class="fas fa-check-circle"></i> Проверено
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-danger">
                                <i class="fas fa-times-circle"></i> Не проверено
                            </span>
                        }
                    </div>
                </div>
                @if (ViewBag.LastInventoryDate != null)
                {
                    <div class="row mt-2">
                        <div class="col-6">
                            <strong>Последняя проверка:</strong>
                        </div>
                        <div class="col-6">
                            @ViewBag.LastInventoryDate.ToString("dd.MM.yyyy HH:mm")
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6">
                            <strong>Инвентаризация:</strong>
                        </div>
                        <div class="col-6">
                            @ViewBag.LastInventoryName
                        </div>
                    </div>
                }
                else
                {
                    <div class="row mt-2">
                        <div class="col-12">
                            <span class="text-muted">Инвентаризации не проводились</span>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div>
    @if (User.IsInRole("Admin") || User.IsInRole("Manager"))
    {
        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">Редактировать</a>
    }
    <a asp-action="Index" class="btn btn-secondary">Назад к списку</a>
</div>