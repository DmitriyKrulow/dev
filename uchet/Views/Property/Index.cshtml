@model IEnumerable<uchet.Models.Property>

@{
    ViewData["Title"] = "Учет имущества";
}

<div class="container-fluid">
    <h2>Учет имущества</h2>

    <!-- Статусная панель -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="d-flex flex-wrap gap-2">
                <div class="status-card bg-primary text-white">
                    <small>Всего</small>
                    <div class="fw-bold">@Model.Count()</div>
                </div>
                <div class="status-card bg-success text-white">
                    <small>Проверено</small>
                    <div class="fw-bold">@Model.Count(x => x.IsCheckedInLastInventory)</div>
                </div>
                <div class="status-card bg-danger text-white">
                    <small>Не проверено</small>
                    <div class="fw-bold">@Model.Count(x => !x.IsCheckedInLastInventory)</div>
                </div>
                <div class="status-card bg-warning text-dark">
                    <small>С истекающим сроком</small>
                    <div class="fw-bold" id="expiringCount">0</div>
                </div>
                <div class="status-card bg-info text-white">
                    <small>Общая стоимость</small>
                    <div class="fw-bold">@(Model.Where(x => x.Cost.HasValue).Sum(x => x.Cost)?.ToString("N0") ?? "0") ₽</div>
                </div>
            </div>
        </div>
    </div>

    <p>
        @if (User.IsInRole("Admin") || User.IsInRole("Manager"))
        {
            <a asp-action="Create" class="btn btn-primary">
                <i class="fas fa-plus-circle me-1"></i> Добавить имущество
            </a>
            <a asp-action="Import" class="btn btn-success">
                <i class="fas fa-file-excel me-1"></i> Импорт из Excel
            </a>
            <button class="btn btn-outline-warning" onclick="showBulkActions()">
                <i class="fas fa-tasks me-1"></i> Групповые операции
            </button>
        }
        <button class="btn btn-outline-info" onclick="toggleQuickFilters()">
            <i class="fas fa-sliders-h me-1"></i> Быстрые фильтры
        </button>
        
        <!-- Обновленная кнопка экспорта -->
        <div class="btn-group">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-download me-1"></i> Экспорт
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportToExcel('all')"><i class="fas fa-table me-2"></i>Все данные</a></li>
                <li><a class="dropdown-item" href="#" onclick="exportToExcel('filtered')"><i class="fas fa-filter me-2"></i>Только отфильтрованные</a></li>
                <li><a class="dropdown-item" href="#" onclick="exportToExcel('selected')"><i class="fas fa-check-square me-2"></i>Только выбранные</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="showExportSettings()"><i class="fas fa-cog me-2"></i>Настройки экспорта</a></li>
            </ul>
        </div>
    </p>

    <!-- Модальное окно настроек экспорта -->
    <div class="modal fade" id="exportSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-cog me-2"></i>Настройки экспорта</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Данные для экспорта:</label>
                        <div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportScope" id="scopeAll" value="all" checked>
                                <label class="form-check-label" for="scopeAll">Все данные</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportScope" id="scopeFiltered" value="filtered">
                                <label class="form-check-label" for="scopeFiltered">Только отфильтрованные</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exportScope" id="scopeSelected" value="selected">
                                <label class="form-check-label" for="scopeSelected">Только выбранные</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Колонки для экспорта:</label>
                        <div class="export-columns-list" style="max-height: 200px; overflow-y: auto;">
                            <div class="form-check">
                                <input class="form-check-input export-column" type="checkbox" value="name" id="colName" checked>
                                <label class="form-check-label" for="colName">Название</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input export-column" type="checkbox" value="type" id="colType" checked>
                                <label class="form-check-label" for="colType">Тип</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input export-column" type="checkbox" value="location" id="colLocation" checked>
                                <label class="form-check-label" for="colLocation">Размещение</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input export-column" type="checkbox" value="user" id="colUser" checked>
                                <label class="form-check-label" for="colUser">Назначено</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input export-column" type="checkbox" value="inventory" id="colInventory" checked>
                                <label class="form-check-label" for="colInventory">Инвентарный номер</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input export-column" type="checkbox" value="cost" id="colCost" checked>
                                <label class="form-check-label" for="colCost">Стоимость</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input export-column" type="checkbox" value="balanceDate" id="colBalanceDate">
                                <label class="form-check-label" for="colBalanceDate">Дата баланса</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input export-column" type="checkbox" value="usagePeriod" id="colUsagePeriod">
                                <label class="form-check-label" for="colUsagePeriod">Срок использования</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input export-column" type="checkbox" value="maintenance" id="colMaintenance">
                                <label class="form-check-label" for="colMaintenance">Последнее обслуживание</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input export-column" type="checkbox" value="expiry" id="colExpiry">
                                <label class="form-check-label" for="colExpiry">Срок годности</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input export-column" type="checkbox" value="status" id="colStatus" checked>
                                <label class="form-check-label" for="colStatus">Статус проверки</label>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAllColumns()">Выбрать все</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllColumns()">Снять все</button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="fileName" class="form-label">Имя файла:</label>
                        <input type="text" class="form-control" id="fileName" value="Учет_имущества_@DateTime.Now.ToString("ddMMyyyy")">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="performExport()"><i class="fas fa-download me-1"></i> Экспорт</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Быстрые фильтры -->
    <div id="quickFilters" class="card mb-3" style="display: none;">
        <div class="card-body">
            <h6 class="card-title"><i class="fas fa-bolt me-1"></i>Быстрые фильтры</h6>
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="filterByStatus('checked')">
                    <i class="fas fa-check-circle me-1"></i>Проверенные
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="filterByStatus('unchecked')">
                    <i class="fas fa-times-circle me-1"></i>Не проверенные
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="filterByStatus('expiring')">
                    <i class="fas fa-clock me-1"></i>С истекающим сроком
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="filterByStatus('no_maintenance')">
                    <i class="fas fa-tools me-1"></i>Требуют обслуживания
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="filterByStatus('no_user')">
                    <i class="fas fa-user-slash me-1"></i>Не назначены
                </button>
            </div>
        </div>
    </div>

    <!-- Групповые операции -->
    <div id="bulkActions" class="card mb-3" style="display: none;">
        <div class="card-body">
            <h6 class="card-title"><i class="fas fa-tasks me-1"></i>Групповые операции</h6>
            <div class="row">
                <div class="col-md-6">
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text">Выбрать</span>
                        <button class="btn btn-outline-secondary" type="button" onclick="selectAll()">Все</button>
                        <button class="btn btn-outline-secondary" type="button" onclick="selectNone()">Ничего</button>
                        <button class="btn btn-outline-secondary" type="button" onclick="selectInverted()">Инвертировать</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">Действия</span>
                        @if (User.IsInRole("Admin"))
                        {
                            <button class="btn btn-outline-warning" type="button" onclick="bulkMarkChecked()">
                                <i class="fas fa-check"></i> Проверено
                            </button>
                            <button class="btn btn-outline-danger" type="button" onclick="bulkMarkUnchecked()">
                                <i class="fas fa-times"></i> Не проверено
                            </button>
                            <button class="btn btn-outline-danger" type="button" onclick="bulkDelete()" title="Удалить выбранные записи">
                                <i class="fas fa-trash"></i> Удалить
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-outline-secondary" type="button" disabled title="Только для администраторов">
                                <i class="fas fa-check"></i> Проверено
                            </button>
                            <button class="btn btn-outline-secondary" type="button" disabled title="Только для администраторов">
                                <i class="fas fa-times"></i> Не проверено
                            </button>
                            <button class="btn btn-outline-secondary" type="button" disabled title="Только для администраторов">
                                <i class="fas fa-trash"></i> Удалить
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form asp-action="Index" method="get" class="mb-3">
        <div class="row">
            <div class="col-md-3">
                <label for="propertyTypeId" class="form-label">Тип имущества:</label>
                <select name="propertyTypeId" asp-items="ViewBag.PropertyTypes" class="form-control form-control-sm">
                    <option value="">Все типы</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="locationId" class="form-label">Размещение:</label>
                <select name="locationId" asp-items="ViewBag.Locations" class="form-control form-control-sm">
                    <option value="">Все размещения</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="userId" class="form-label">Пользователь:</label>
                <select name="userId" asp-items="ViewBag.Users" class="form-control form-control-sm">
                    <option value="">Все пользователи</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-flex gap-1 flex-wrap">
                    <button type="submit" class="btn btn-primary btn-sm" title="Применить фильтры">
                        <i class="fas fa-filter"></i>
                    </button>
                    <a asp-action="Index" class="btn btn-secondary btn-sm" title="Сбросить фильтры">
                        <i class="fas fa-undo"></i>
                    </a>
                    <button type="button" class="btn btn-info btn-sm" onclick="printTable()" title="Печать таблицы">
                        <i class="fas fa-print"></i>
                    </button>
                    
                    <a href="@Url.Action("PrintQRCodes", new { propertyTypeId = Context.Request.Query["propertyTypeId"], locationId = Context.Request.Query["locationId"], userId = Context.Request.Query["userId"] })" 
                       class="btn btn-outline-primary btn-sm" target="_blank" title="Печать QR кодов">
                        <i class="fas fa-qrcode"></i>
                    </a>
                    <a href="@Url.Action("PrintBarcodes", new { propertyTypeId = Context.Request.Query["propertyTypeId"], locationId = Context.Request.Query["locationId"], userId = Context.Request.Query["userId"] })" 
                       class="btn btn-outline-primary btn-sm" target="_blank" title="Печать штрих-кодов">
                        <i class="fas fa-barcode"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Строка поиска -->
        <div class="row mt-3">
            <div class="col-md-6">
                <div class="input-group input-group-sm">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="Поиск по названию или инвентарному номеру..." 
                           title="Введите название или инвентарный номер">
                    <button class="btn btn-outline-secondary" type="button" onclick="performSearch()" title="Найти">
                        <i class="fas fa-search"></i> Найти
                    </button>
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()" title="Очистить поиск">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="searchType" id="searchByName" value="name" checked>
                    <label class="form-check-label" for="searchByName">По названию</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="searchType" id="searchByInventory" value="inventory">
                    <label class="form-check-label" for="searchByInventory">По инвентарному номеру</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="searchType" id="searchByBoth" value="both">
                    <label class="form-check-label" for="searchByBoth">По обоим</label>
                </div>
            </div>
        </div>
    </form>

    <!-- Панель управления видом таблицы -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <button class="btn btn-outline-secondary btn-sm" onclick="toggleOptionalColumns()">
                <i class="fas fa-columns me-1"></i> Настроить столбцы
            </button>
            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="showAllRows()">
                <i class="fas fa-eye me-1"></i> Показать все
            </button>
            <div class="btn-group ms-2">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-sort me-1"></i> Сортировка
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="sortTable('name')">По названию</a></li>
                    <li><a class="dropdown-item" href="#" onclick="sortTable('inventory')">По инв. номеру</a></li>
                    <li><a class="dropdown-item" href="#" onclick="sortTable('cost')">По стоимости</a></li>
                    <li><a class="dropdown-item" href="#" onclick="sortTable('date')">По дате добавления</a></li>
                </ul>
            </div>
        </div>
        
        <div class="d-flex align-items-center">
            <span id="searchResults" class="me-2 text-muted small" style="display: none;"></span>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                <label class="form-check-label small" for="autoRefresh">Автообновление</label>
            </div>
        </div>
    </div>

    <!-- Контейнер таблицы -->
    <div class="table-container" style="max-height: calc(100vh - 400px); overflow-y: auto;">
        <div class="table-responsive">
            <table class="table table-striped table-sm table-hover" id="propertyTable">
                <thead class="sticky-top">
                    <tr>
                        <th width="30">
                            <input type="checkbox" id="selectAllHeader" onchange="toggleAllSelection()">
                        </th>
                        <th>Название</th>
                        <th>Тип</th>
                        <th class="optional-column">Размещение</th>
                        <th class="optional-column">Назначено</th>
                        <th class="optional-column">QR код</th>
                        <th class="optional-column">Штрих-код</th>
                        <th>Инвентарный номер</th>
                        <th class="optional-column">Дата баланса</th>
                        <th class="optional-column">Срок использования</th>
                        <th>Стоимость</th>
                        <th class="optional-column">Последнее обслуживание</th>
                        <th class="optional-column">Срок годности</th>
                        <th>Статус проверки</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    @foreach (var item in Model)
                    {
                        <tr data-id="@item.Id" data-name="@item.Name?.ToLower()" data-inventory="@item.InventoryNumber?.ToLower()"
                            data-cost="@item.Cost" data-date="@(item.BalanceDate?.ToString("yyyyMMdd") ?? "")"
                            data-status="@item.IsCheckedInLastInventory" data-expiry="@item.ExpiryDate?.ToString("yyyyMMdd")">
                            <td>
                                <input type="checkbox" class="row-selector" onchange="updateSelectionCount()">
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <span title="@item.Name">@TruncateString(item.Name, 25)</span>
                                    @if (item.ExpiryDate.HasValue && item.ExpiryDate.Value < DateTime.Now.AddDays(30))
                                    {
                                        <i class="fas fa-clock text-warning ms-1" title="Срок годности истекает"></i>
                                    }
                                </div>
                            </td>
                            <td>@item.PropertyType?.Name</td>
                            <td class="optional-column" title="@item.Location?.Name">@TruncateString(item.Location?.Name, 20)</td>
                            <td class="optional-column" title="@item.AssignedUser?.Name">@TruncateString(item.AssignedUser?.Name, 15)</td>
                            <td class="optional-column">
                                @if (!string.IsNullOrEmpty(item.QRCode))
                                {
                                    <img src="@Url.Action("GenerateQRCodeImage", new { id = item.Id })" alt="QR Code" 
                                         style="max-width: 50px; max-height: 50px;" 
                                         title="QR код для @item.Name" />
                                }
                                else
                                {
                                    <span class="text-muted" title="QR код отсутствует">
                                        <i class="fas fa-qrcode"></i>
                                    </span>
                                }
                            </td>
                            <td class="optional-column">
                                @if (!string.IsNullOrEmpty(item.Barcode))
                                {
                                    <img src="@Url.Action("GenerateBarcodeImage", new { id = item.Id })" alt="Barcode" 
                                         style="max-width: 50px; max-height: 50px;" 
                                         title="Штрих-код для @item.Name" />
                                }
                                else
                                {
                                    <span class="text-muted" title="Штрих-код отсутствует">
                                        <i class="fas fa-barcode"></i>
                                    </span>
                                }
                            </td>
                            <td><strong>@item.InventoryNumber</strong></td>
                            <td class="optional-column">@(item.BalanceDate?.ToString("dd.MM.yyyy") ?? "-")</td>
                            <td class="optional-column">@(item.UsagePeriod?.ToString() ?? "-") мес.</td>
                            <td><strong>@(item.Cost?.ToString("N0") ?? "-") ₽</strong></td>
                            <td class="optional-column">@(item.LastMaintenanceDate?.ToString("dd.MM.yyyy") ?? "-")</td>
                            <td class="optional-column">
                                @if (item.ExpiryDate.HasValue)
                                {
                                    if (item.ExpiryDate.Value < DateTime.Now)
                                    {
                                        <span class="text-danger" title="Срок годности истек">
                                            @item.ExpiryDate.Value.ToString("dd.MM.yyyy")
                                            <i class="fas fa-exclamation-triangle ms-1"></i>
                                        </span>
                                    }
                                    else if (item.ExpiryDate.Value < DateTime.Now.AddMonths(1))
                                    {
                                        <span class="text-warning" title="Срок годности скоро истекает">
                                            @item.ExpiryDate.Value.ToString("dd.MM.yyyy")
                                            <i class="fas fa-clock ms-1"></i>
                                        </span>
                                    }
                                    else
                                    {
                                        @item.ExpiryDate.Value.ToString("dd.MM.yyyy")
                                    }
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </td>
                            <td>
                                @if (item.IsCheckedInLastInventory)
                                {
                                    <span class="badge bg-success" title="Последняя проверка: @(item.LastInventoryCheckDate?.ToString("dd.MM.yyyy") ?? "Не указана")">
                                        <i class="fas fa-check me-1"></i> Проверено
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-danger" title="Последняя проверка: @(item.LastInventoryCheckDate?.ToString("dd.MM.yyyy") ?? "Не проводилась")">
                                        <i class="fas fa-times me-1"></i> Не проверено
                                    </span>
                                }
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-info" title="Просмотреть детали">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    @if (User.IsInRole("Admin") || User.IsInRole("Manager"))
                                    {
                                        <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-warning" title="Редактировать">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    }
                                    @if (User.IsInRole("Admin"))
                                    {
                                        <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-danger" title="Удалить">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Пагинация и информация -->
    <div class="d-flex justify-content-between align-items-center mt-2">
        <div>
            <small class="text-muted">
                Показано записей: <strong id="totalCount">@Model.Count()</strong>
                <span id="filteredCount" style="display: none;"></span>
                <span id="selectedCount" class="ms-2" style="display: none;"></span>
            </small>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" onclick="changePageSize(-10)">
                <i class="fas fa-minus"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" disabled>
                Размер: <span id="pageSize">50</span>
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="changePageSize(10)">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>
        <!-- Модальное окно для просмотра изображений -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" alt="" class="img-fluid">
                </div>
            </div>
        </div>
    </div>

    <!-- Контейнер для алертов -->
    <div id="alertContainer"></div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" style="display: none;"></div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <script>
        // Глобальная переменная для отслеживания состояния колонок
        let areOptionalColumnsHidden = false;

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - initializing optional columns');
            updateExpiringCount();
            
            // Проверяем сохраненное состояние колонок
            areOptionalColumnsHidden = localStorage.getItem('optionalColumnsHidden') === 'true';
            console.log('Loaded from localStorage:', areOptionalColumnsHidden);
            
            const optionalCells = document.querySelectorAll('th.optional-column, td.optional-column');
            console.log('Optional cells found on init:', optionalCells.length);
            
            // Применяем сохраненное состояние
            optionalCells.forEach(cell => {
                cell.style.display = areOptionalColumnsHidden ? 'none' : '';
            });
            
            // Обновляем кнопку
            updateToggleButton();
        });

        // Функции экспорта
        function showExportSettings() {
            const modal = new bootstrap.Modal(document.getElementById('exportSettingsModal'));
            modal.show();
        }

        function exportToExcel(scope) {
            document.querySelector(`input[name="exportScope"][value="${scope}"]`).checked = true;
            showExportSettings();
        }

        function selectAllColumns() {
            document.querySelectorAll('.export-column').forEach(cb => {
                cb.checked = true;
            });
        }

        function deselectAllColumns() {
            document.querySelectorAll('.export-column').forEach(cb => {
                cb.checked = false;
            });
        }

        function performExport() {
            const scope = document.querySelector('input[name="exportScope"]:checked').value;
            const fileName = document.getElementById('fileName').value || 'Учет_имущества';
            
            const selectedColumns = [];
            document.querySelectorAll('.export-column:checked').forEach(cb => {
                selectedColumns.push(cb.value);
            });
            
            if (selectedColumns.length === 0) {
                showAlert('Выберите хотя бы одну колонку для экспорта', 'warning');
                return;
            }
            
            let dataToExport = [];
            
            if (scope === 'selected') {
                document.querySelectorAll('.row-selector:checked').forEach(cb => {
                    const row = cb.closest('tr');
                    dataToExport.push(prepareRowData(row));
                });
                
                if (dataToExport.length === 0) {
                    showAlert('Выберите записи для экспорта', 'warning');
                    return;
                }
            } else if (scope === 'filtered') {
                document.querySelectorAll('#tableBody tr').forEach(row => {
                    if (row.style.display !== 'none') {
                        dataToExport.push(prepareRowData(row));
                    }
                });
            } else {
                document.querySelectorAll('#tableBody tr').forEach(row => {
                    dataToExport.push(prepareRowData(row));
                });
            }
            
            showLoading(true, 'Подготовка данных для экспорта...');
            
            fetch('/Property/ExportData', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getAntiForgeryToken()
                },
                body: JSON.stringify({
                    data: dataToExport,
                    columns: selectedColumns,
                    fileName: fileName
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сервера');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `${fileName}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert(`Файл успешно экспортирован (${dataToExport.length} записей)`, 'success');
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('exportSettingsModal'));
                modal.hide();
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Ошибка при экспорте данных', 'error');
            })
            .finally(() => {
                showLoading(false);
            });
        }

        function prepareRowData(row) {
            return {
                id: row.getAttribute('data-id'),
                name: row.querySelector('td:nth-child(2)')?.textContent.trim() || '',
                type: row.querySelector('td:nth-child(3)')?.textContent.trim() || '',
                location: row.querySelector('td:nth-child(4)')?.textContent.trim() || '',
                user: row.querySelector('td:nth-child(5)')?.textContent.trim() || '',
                inventory: row.querySelector('td:nth-child(8)')?.textContent.trim() || '',
                cost: row.querySelector('td:nth-child(11)')?.textContent.trim() || '',
                balanceDate: row.querySelector('td:nth-child(9)')?.textContent.trim() || '',
                usagePeriod: row.querySelector('td:nth-child(10)')?.textContent.trim() || '',
                maintenance: row.querySelector('td:nth-child(12)')?.textContent.trim() || '',
                expiry: row.querySelector('td:nth-child(13)')?.textContent.trim() || '',
                status: row.querySelector('td:nth-child(14)')?.textContent.trim() || ''
            };
        }

        function showLoading(show, message = 'Загрузка...') {
            let loading = document.getElementById('loadingOverlay');
            if (!loading && show) {
                loading = document.createElement('div');
                loading.id = 'loadingOverlay';
                loading.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center';
                loading.style.backgroundColor = 'rgba(0,0,0,0.5)';
                loading.style.zIndex = '9998';
                loading.innerHTML = `
                    <div class="bg-white rounded p-4 d-flex align-items-center">
                        <div class="spinner-border text-primary me-3" role="status"></div>
                        <div>${message}</div>
                    </div>
                `;
                document.body.appendChild(loading);
            } else if (loading && !show) {
                loading.remove();
            }
        }

        // Поиск по таблице
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const searchType = document.querySelector('input[name="searchType"]:checked').value;
            const rows = document.querySelectorAll('#tableBody tr');
            let visibleCount = 0;

            if (!searchTerm) {
                showAllRows();
                return;
            }

            rows.forEach(row => {
                const name = row.getAttribute('data-name') || '';
                const inventory = row.getAttribute('data-inventory') || '';
                let matches = false;

                switch (searchType) {
                    case 'name':
                        matches = name.includes(searchTerm);
                        break;
                    case 'inventory':
                        matches = inventory.includes(searchTerm);
                        break;
                    case 'both':
                        matches = name.includes(searchTerm) || inventory.includes(searchTerm);
                        break;
                }

                if (matches) {
                    row.style.display = '';
                    visibleCount++;
                    highlightText(row, searchTerm);
                } else {
                    row.style.display = 'none';
                }
            });

            updateSearchResults(visibleCount, searchTerm);
        }

        function highlightText(row, searchTerm) {
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                const originalHTML = cell.innerHTML;
                const highlightedHTML = originalHTML.replace(
                    new RegExp(searchTerm, 'gi'),
                    match => `<span class="bg-warning">${match}</span>`
                );
                cell.innerHTML = highlightedHTML;
            });
        }

        function removeHighlight() {
            const highlights = document.querySelectorAll('.bg-warning');
            highlights.forEach(highlight => {
                const parent = highlight.parentNode;
                parent.innerHTML = parent.innerHTML.replace(/<span class="bg-warning">(.*?)<\/span>/g, '$1');
            });
        }

        function showAllRows() {
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
            removeHighlight();
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('filteredCount').style.display = 'none';
            document.getElementById('totalCount').style.display = 'inline';
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            showAllRows();
        }

        function updateSearchResults(visibleCount, searchTerm) {
            const totalCount = @Model.Count();
            const searchResults = document.getElementById('searchResults');
            const filteredCount = document.getElementById('filteredCount');
            const totalCountElement = document.getElementById('totalCount');

            if (visibleCount === 0) {
                searchResults.innerHTML = `<i class="fas fa-exclamation-triangle text-warning"></i> По запросу "${searchTerm}" ничего не найдено`;
                searchResults.className = 'me-2 text-warning small';
            } else {
                searchResults.innerHTML = `<i class="fas fa-check text-success"></i> Найдено записей: ${visibleCount}`;
                searchResults.className = 'me-2 text-success small';
            }

            searchResults.style.display = 'inline';
            filteredCount.textContent = ` (отфильтровано: ${visibleCount})`;
            filteredCount.style.display = 'inline';
            totalCountElement.style.display = 'none';
        }

        // Поиск при нажатии Enter
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });

        // Автопоиск при вводе (с задержкой)
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, 500);
        });

        // Статусная панель - подсчет истекающих сроков
        function updateExpiringCount() {
            const rows = document.querySelectorAll('#tableBody tr');
            let expiringCount = 0;
            
            rows.forEach(row => {
                const expiry = row.getAttribute('data-expiry');
                if (expiry && expiry !== 'null') {
                    const year = expiry.substring(0,4);
                    const month = expiry.substring(4,6);
                    const day = expiry.substring(6,8);
                    const expiryDate = new Date(year, month-1, day);
                    const today = new Date();
                    const daysDiff = (expiryDate - today) / (1000 * 60 * 60 * 24);
                    
                    if (daysDiff > 0 && daysDiff <= 30) {
                        expiringCount++;
                    }
                }
            });
            
            document.getElementById('expiringCount').textContent = expiringCount;
        }

        // Быстрые фильтры
        function toggleQuickFilters() {
            const quickFilters = document.getElementById('quickFilters');
            quickFilters.style.display = quickFilters.style.display === 'none' ? 'block' : 'none';
        }

        function filterByStatus(status) {
            const rows = document.querySelectorAll('#tableBody tr');
            let count = 0;
            
            rows.forEach(row => {
                let show = false;
                const expiry = row.getAttribute('data-expiry');
                const statusVal = row.getAttribute('data-status');
                const userCell = row.querySelector('td:nth-child(5)');
                const user = userCell ? userCell.textContent.trim() : '';
                
                switch(status) {
                    case 'checked':
                        show = statusVal === 'True';
                        break;
                    case 'unchecked':
                        show = statusVal === 'False';
                        break;
                    case 'expiring':
                        if (expiry && expiry !== 'null') {
                            const year = expiry.substring(0,4);
                            const month = expiry.substring(4,6);
                            const day = expiry.substring(6,8);
                            const expiryDate = new Date(year, month-1, day);
                            const today = new Date();
                            const daysDiff = (expiryDate - today) / (1000 * 60 * 60 * 24);
                            show = daysDiff > 0 && daysDiff <= 30;
                        }
                        break;
                    case 'no_maintenance':
                        const maintenanceCell = row.querySelector('td:nth-child(12)');
                        const maintenance = maintenanceCell ? maintenanceCell.textContent.trim() : '';
                        show = maintenance === '-' || maintenance === '';
                        break;
                    case 'no_user':
                        show = user === '-' || user === '' || !user;
                        break;
                }
                
                row.style.display = show ? '' : 'none';
                if (show) count++;
            });
            
            updateFilteredCount(count, status);
        }

        function updateFilteredCount(count, status) {
            const filteredCount = document.getElementById('filteredCount');
            const totalCountElement = document.getElementById('totalCount');
            
            filteredCount.textContent = ` (отфильтровано: ${count})`;
            filteredCount.style.display = 'inline';
            totalCountElement.style.display = 'none';
            
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = `<i class="fas fa-filter text-info"></i> Применен фильтр: ${getStatusName(status)}`;
            searchResults.className = 'me-2 text-info small';
            searchResults.style.display = 'inline';
        }

        function getStatusName(status) {
            const statusNames = {
                'checked': 'Проверенные',
                'unchecked': 'Не проверенные',
                'expiring': 'С истекающим сроком',
                'no_maintenance': 'Требуют обслуживания',
                'no_user': 'Не назначены'
            };
            return statusNames[status] || status;
        }

        // Групповые операции
        function showBulkActions() {
            document.getElementById('bulkActions').style.display = 'block';
        }

        function selectAll() {
            document.querySelectorAll('.row-selector').forEach(cb => cb.checked = true);
            updateSelectionCount();
        }

        function selectNone() {
            document.querySelectorAll('.row-selector').forEach(cb => cb.checked = false);
            updateSelectionCount();
        }

        function selectInverted() {
            document.querySelectorAll('.row-selector').forEach(cb => cb.checked = !cb.checked);
            updateSelectionCount();
        }

        function toggleAllSelection() {
            const headerCheckbox = document.getElementById('selectAllHeader');
            document.querySelectorAll('.row-selector').forEach(cb => cb.checked = headerCheckbox.checked);
            updateSelectionCount();
        }

        function updateSelectionCount() {
            const selected = document.querySelectorAll('.row-selector:checked').length;
            const selectedCount = document.getElementById('selectedCount');
            if (selected > 0) {
                selectedCount.textContent = `Выбрано: ${selected}`;
                selectedCount.style.display = 'inline';
            } else {
                selectedCount.style.display = 'none';
            }
        }

        // Групповое удаление
        function bulkDelete() {
            const selectedIds = [];
            const selectedNames = [];
            
            document.querySelectorAll('.row-selector:checked').forEach(cb => {
                const row = cb.closest('tr');
                selectedIds.push(row.getAttribute('data-id'));
                
                const nameCell = row.querySelector('td:nth-child(2)');
                if (nameCell) {
                    selectedNames.push(nameCell.textContent.trim());
                }
            });
            
            if (selectedIds.length === 0) {
                showAlert('Выберите записи для удаления', 'warning');
                return;
            }
            
            let message = `Вы уверены, что хотите удалить выбранные записи (${selectedIds.length} шт.)?\n\n`;
            
            if (selectedNames.length > 0) {
                const previewNames = selectedNames.slice(0, 3);
                message += 'Будут удалены:\n';
                previewNames.forEach(name => {
                    message += `• ${name}\n`;
                });
                if (selectedNames.length > 3) {
                    message += `• ... и еще ${selectedNames.length - 3} записей\n`;
                }
            }
            
            message += '\n⚠️ Это действие нельзя отменить!';
            
            if (confirm(message)) {
                if (selectedIds.length > 5) {
                    const finalConfirm = confirm(`Вы собираетесь удалить ${selectedIds.length} записей. Это критическая операция!\n\nНажмите OK для подтверждения удаления.`);
                    if (!finalConfirm) {
                        return;
                    }
                }
                
                showLoading(true);
                
                fetch('/Property/BulkDelete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: JSON.stringify({ ids: selectedIds })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сервера');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showAlert(`Успешно удалено ${selectedIds.length} записей`, 'success');
                        selectedIds.forEach(id => {
                            const row = document.querySelector(`tr[data-id="${id}"]`);
                            if (row) {
                                row.remove();
                            }
                        });
                        updateTotalCount();
                        updateExpiringCount();
                        selectNone();
                    } else {
                        throw new Error(data.message || 'Ошибка при удалении');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Ошибка при удалении записей', 'error');
                })
                .finally(() => {
                    showLoading(false);
                });
            }
        }

        // Массовое изменение статуса проверки
        function bulkMarkChecked() {
            const selectedIds = [];
            document.querySelectorAll('.row-selector:checked').forEach(cb => {
                const row = cb.closest('tr');
                selectedIds.push(parseInt(row.getAttribute('data-id')));
            });
            
            if (selectedIds.length === 0) {
                showAlert('Выберите записи для выполнения операции', 'warning');
                return;
            }
            
            if (confirm(`Отметить проверенными ${selectedIds.length} записей?`)) {
                showLoading(true, 'Обновление статуса проверки...');
                
                fetch('/Property/BulkUpdateCheckStatus', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: JSON.stringify({
                        ids: selectedIds,
                        isChecked: true
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сервера');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showAlert(data.message, 'success');
                        // Обновляем отображение статуса в таблице
                        selectedIds.forEach(id => {
                            const row = document.querySelector(`tr[data-id="${id}"]`);
                            if (row) {
                                row.setAttribute('data-status', 'True');
                                const statusCell = row.querySelector('td:nth-child(14)');
                                if (statusCell) {
                                    statusCell.innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i> Проверено</span>';
                                }
                            }
                        });
                        updateStatusCounts();
                    } else {
                        throw new Error(data.message || 'Ошибка при обновлении статуса');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Ошибка при обновлении статуса проверки', 'error');
                })
                .finally(() => {
                    showLoading(false);
                });
            }
        }

        function bulkMarkUnchecked() {
            const selectedIds = [];
            document.querySelectorAll('.row-selector:checked').forEach(cb => {
                const row = cb.closest('tr');
                selectedIds.push(parseInt(row.getAttribute('data-id')));
            });
            
            if (selectedIds.length === 0) {
                showAlert('Выберите записи для выполнения операции', 'warning');
                return;
            }
            
            if (confirm(`Отметить не проверенными ${selectedIds.length} записей?`)) {
                showLoading(true, 'Обновление статуса проверки...');
                
                fetch('/Property/BulkUpdateCheckStatus', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: JSON.stringify({
                        ids: selectedIds,
                        isChecked: false
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сервера');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showAlert(data.message, 'success');
                        // Обновляем отображение статуса в таблице
                        selectedIds.forEach(id => {
                            const row = document.querySelector(`tr[data-id="${id}"]`);
                            if (row) {
                                row.setAttribute('data-status', 'False');
                                const statusCell = row.querySelector('td:nth-child(14)');
                                if (statusCell) {
                                    statusCell.innerHTML = '<span class="badge bg-danger"><i class="fas fa-times me-1"></i> Не проверено</span>';
                                }
                            }
                        });
                        updateStatusCounts();
                    } else {
                        throw new Error(data.message || 'Ошибка при обновлении статуса');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Ошибка при обновлении статуса проверки', 'error');
                })
                .finally(() => {
                    showLoading(false);
                });
            }
        }

        function updateStatusCounts() {
            const totalRows = document.querySelectorAll('#tableBody tr').length;
            const checkedCount = document.querySelectorAll('#tableBody tr[data-status="True"]').length;
            const uncheckedCount = totalRows - checkedCount;
            
            // Обновляем статусную панель
            document.querySelector('.status-card.bg-success .fw-bold').textContent = checkedCount;
            document.querySelector('.status-card.bg-danger .fw-bold').textContent = uncheckedCount;
        }

        // Вспомогательные функции
        function showAlert(message, type = 'info') {
            let alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) {
                alertContainer = document.createElement('div');
                alertContainer.id = 'alertContainer';
                alertContainer.className = 'position-fixed top-0 end-0 p-3';
                alertContainer.style.zIndex = '9999';
                document.body.appendChild(alertContainer);
            }
            
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info';
            
            const alertId = 'alert-' + Date.now();
            const alertHTML = `
                <div id="${alertId}" class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <strong>${type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ'}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHTML);
            
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }

        function getAntiForgeryToken() {
            return document.querySelector('input[name="__RequestVerificationToken"]')?.value;
        }

        function updateTotalCount() {
            const totalRows = document.querySelectorAll('#tableBody tr').length;
            document.getElementById('totalCount').textContent = totalRows;
        }

        // Сортировка
        function sortTable(by) {
            const tbody = document.getElementById('tableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                let aVal, bVal;
                
                switch(by) {
                    case 'name':
                        aVal = a.getAttribute('data-name') || '';
                        bVal = b.getAttribute('data-name') || '';
                        return aVal.localeCompare(bVal);
                    case 'inventory':
                        aVal = a.querySelector('td:nth-child(8)')?.textContent || '';
                        bVal = b.querySelector('td:nth-child(8)')?.textContent || '';
                        return aVal.localeCompare(bVal);
                    case 'cost':
                        aVal = parseFloat(a.getAttribute('data-cost')) || 0;
                        bVal = parseFloat(b.getAttribute('data-cost')) || 0;
                        return bVal - aVal;
                    case 'date':
                        aVal = a.getAttribute('data-date') || '';
                        bVal = b.getAttribute('data-date') || '';
                        return bVal.localeCompare(aVal);
                    default:
                        return 0;
                }
            });
            
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        // Автообновление
        let refreshInterval;
        function toggleAutoRefresh() {
            const autoRefresh = document.getElementById('autoRefresh').checked;
            if (autoRefresh) {
                refreshInterval = setInterval(() => {
                    console.log('Auto-refresh triggered');
                }, 30000);
            } else {
                clearInterval(refreshInterval);
            }
        }

        // Изменение размера страницы
        function changePageSize(delta) {
            let currentSize = parseInt(document.getElementById('pageSize').textContent);
            let newSize = Math.max(10, Math.min(100, currentSize + delta));
            document.getElementById('pageSize').textContent = newSize;
            console.log('Page size changed to:', newSize);
        }

        // Управление колонками
        function toggleOptionalColumns() {
            console.log('toggleOptionalColumns called, current state:', areOptionalColumnsHidden);
            
            // Получаем все ячейки с классом optional-column
            const optionalCells = document.querySelectorAll('th.optional-column, td.optional-column');
            console.log('Found optional cells:', optionalCells.length);
            
            if (optionalCells.length === 0) {
                console.log('No optional columns found');
                return;
            }
            
            // Переключаем состояние
            areOptionalColumnsHidden = !areOptionalColumnsHidden;
            
            // Применяем новое состояние ко всем ячейкам
            optionalCells.forEach(cell => {
                cell.style.display = areOptionalColumnsHidden ? 'none' : '';
            });
            
            // Сохраняем состояние в localStorage
            localStorage.setItem('optionalColumnsHidden', areOptionalColumnsHidden);
            console.log('New state saved to localStorage:', areOptionalColumnsHidden);
            
            // Обновляем кнопку
            updateToggleButton();
        }

        function updateToggleButton() {
            const button = document.querySelector('button[onclick="toggleOptionalColumns()"]');
            if (button) {
                const icon = button.querySelector('i');
                if (icon) {
                    if (areOptionalColumnsHidden) {
                        icon.className = 'fas fa-eye me-1';
                        button.title = 'Показать дополнительные столбцы';
                    } else {
                        icon.className = 'fas fa-eye-slash me-1';
                        button.title = 'Скрыть дополнительные столбцы';
                    }
                }
            }
        }

        // Функция для печати таблицы
        function printTable() {
            window.print();
        }

        // Функция для просмотра изображений в модальном окне
        function showImageModal(imageUrl, title) {
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('imageModalTitle').textContent = title;
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }
    </script>
}

@functions {
    public string TruncateString(string value, int maxLength)
    {
        if (string.IsNullOrEmpty(value)) return value;
        return value.Length <= maxLength ? value : value.Substring(0, maxLength) + "...";
    }
}