<!-- Views/Scan/Index.cshtml -->
@{
    ViewData["Title"] = "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞";
}

<div class="container-fluid px-2 px-md-3">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="row mb-3">
        <div class="col-12">
            <h1 class="h3 mb-1">@ViewData["Title"]</h1>
            <p class="text-muted mb-0" id="userInfo">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ...</p>
        </div>
    </div>

    <div class="row g-3">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ -->
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white py-2">
                    <h5 class="card-title mb-0 d-flex align-items-center">
                        <i class="bi bi-qr-code-scan me-2 fs-6"></i>
                        <span class="fs-6">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞</span>
                    </h5>
                </div>
                <div class="card-body p-3">
                    <!-- –í—ã–±–æ—Ä –∫–∞–º–µ—Ä—ã -->
                    <div class="mb-3">
                        <label for="cameraSelect" class="form-label small fw-medium">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É:</label>
                        <select id="cameraSelect" class="form-select form-select-sm">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</option>
                        </select>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–∞–Ω–µ—Ä–æ–º -->
                    <div class="mb-3 d-grid gap-2 d-md-flex">
                        <button id="startScanner" class="btn btn-primary btn-sm flex-fill" disabled>
                            <i class="bi bi-camera-video me-1"></i>–ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                        </button>
                        <button id="stopScanner" class="btn btn-outline-secondary btn-sm flex-fill" disabled>
                            <i class="bi bi-stop-circle me-1"></i>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>

                    <!-- –û–±–ª–∞—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                    <div id="qr-reader" class="border rounded bg-light" style="min-height: 250px; display: none;"></div>
                    
                    <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ -->
                    <div class="mt-3">
                        <label for="manualInput" class="form-label small fw-medium">–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é:</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="manualInput" placeholder="–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –Ω–æ–º–µ—Ä">
                            <button class="btn btn-outline-primary" type="button" id="manualScan">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="col-12 col-lg-6">
            <!-- –ü–µ—Ä–µ–¥–∞—á–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é -->
            <div id="transferToUser" style="display: none;">
                <div class="card shadow-sm border-success">
                    <div class="card-header bg-success text-white py-2">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                            <i class="bi bi-arrow-left-right me-2 fs-6"></i>
                            <span class="fs-6">–ü–µ—Ä–µ–¥–∞—á–∞ –∏–º—É—â–µ—Å—Ç–≤–∞</span>
                        </h5>
                    </div>
                    <div class="card-body p-3">
                        <div id="transferPropertyDetails" class="small">
                            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–º—É—â–µ—Å—Ç–≤–µ -->
                        </div>
                        
                        <div class="mt-3 pt-2 border-top">
                            <p class="text-muted small mb-2">–ò–º—É—â–µ—Å—Ç–≤–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–æ –≤–∞–º</p>
                            <div class="d-grid">
                                <button class="btn btn-success btn-sm" id="confirmTransferToUser">
                                    <i class="bi bi-check-circle me-1"></i>–ü—Ä–∏–Ω—è—Ç—å –∏–º—É—â–µ—Å—Ç–≤–æ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ —Å–∫–ª–∞–¥ -->
            <div id="returnToWarehouse" style="display: none;">
                <div class="card shadow-sm border-warning">
                    <div class="card-header bg-warning text-dark py-2">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                            <i class="bi bi-arrow-left-circle me-2 fs-6"></i>
                            <span class="fs-6">–ü—Ä–∏–Ω—è—Ç—å –Ω–∞ —Å–∫–ª–∞–¥</span>
                        </h5>
                    </div>
                    <div class="card-body p-3">
                        <div id="returnPropertyDetails" class="small">
                            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–º—É—â–µ—Å—Ç–≤–µ -->
                        </div>
                        
                        <div class="mt-3 pt-2 border-top">
                            <p class="text-muted small mb-2">–ò–º—É—â–µ—Å—Ç–≤–æ –±—É–¥–µ—Ç –ø—Ä–∏–Ω—è—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥</p>
                            <div class="d-grid">
                                <button class="btn btn-warning btn-sm" id="confirmReturnToWarehouse">
                                    <i class="bi bi-arrow-return-left me-1"></i>–ü—Ä–∏–Ω—è—Ç—å –Ω–∞ —Å–∫–ª–∞–¥
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ò–º—É—â–µ—Å—Ç–≤–æ —É–∂–µ —É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div id="propertyWithCurrentUser" style="display: none;">
                <div class="card shadow-sm border-info">
                    <div class="card-header bg-info text-white py-2">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                            <i class="bi bi-person-check me-2 fs-6"></i>
                            <span class="fs-6">–ò–º—É—â–µ—Å—Ç–≤–æ —É –≤–∞—Å</span>
                        </h5>
                    </div>
                    <div class="card-body p-3">
                        <div id="currentUserPropertyDetails" class="small">
                            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–º—É—â–µ—Å—Ç–≤–µ -->
                        </div>
                        
                        <div class="mt-3 pt-2 border-top">
                            <p class="text-success small mb-0">
                                <i class="bi bi-info-circle me-1"></i>–≠—Ç–æ –∏–º—É—â–µ—Å—Ç–≤–æ —É–∂–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ –∑–∞ –≤–∞–º–∏
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ò–º—É—â–µ—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ -->
            <div id="noProperty" style="display: none;">
                <div class="card shadow-sm border-danger">
                    <div class="card-header bg-danger text-white py-2">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle me-2 fs-6"></i>
                            <span class="fs-6">–ò–º—É—â–µ—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</span>
                        </h5>
                    </div>
                    <div class="card-body p-3">
                        <p class="small mb-2">–ò–º—É—â–µ—Å—Ç–≤–æ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Å–∏—Å—Ç–µ–º–µ.</p>
                        <p class="small text-muted mb-0">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p>
                    </div>
                </div>
            </div>

            <!-- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ -->
            <div id="scannerNotSupported" style="display: none;">
                <div class="card shadow-sm border-dark">
                    <div class="card-header bg-dark text-white py-2">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                            <i class="bi bi-exclamation-circle me-2 fs-6"></i>
                            <span class="fs-6">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span>
                        </h5>
                    </div>
                    <div class="card-body p-3">
                        <p class="small mb-2">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.</p>
                        <p class="small text-muted mb-0">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        #qr-reader {
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }

        .property-detail {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
            line-height: 1.4;
        }
        
        .property-detail strong {
            display: inline-block;
            width: 110px;
            color: #6c757d;
            font-weight: 500;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .scanner-loading {
            color: #6c757d;
            text-align: center;
            padding: 2rem;
        }

        @@media (max-width: 576px) {
            .container-fluid {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            .card-body {
                padding: 1rem !important;
            }
            
            .property-detail strong {
                width: 100px;
            }
        }
    </style>
}

@section Scripts {
    <script>
        let html5QrCode = null;
        let currentPropertyId = null;
        let isScannerLoaded = false;
        let currentUserId = null;
        let currentUserName = null;
        let currentUserLocation = null;
        let currentUserIsAdmin = false;

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        async function getCurrentUser() {
            try {
                const response = await fetch('/Scan/GetCurrentUser');
                const user = await response.json();
                
                if (user.id) {
                    currentUserId = user.id;
                    currentUserName = user.name;
                    currentUserLocation = user.location || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                    currentUserIsAdmin = user.isAdmin || false;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
                    updateUserInfoInHeader();
                } else {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ');
                    showAlert('–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏', 'danger');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'danger');
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
        function updateUserInfoInHeader() {
            const header = document.getElementById('userInfo');
            if (header && currentUserName) {
                let userInfo = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${currentUserName}`;
                if (currentUserLocation) {
                    userInfo += ` | –õ–æ–∫–∞—Ü–∏—è: ${currentUserLocation}`;
                }
                if (currentUserIsAdmin) {
                    userInfo += ' | –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
                }
                header.textContent = userInfo;
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å–∫–∞–Ω–µ—Ä–æ–º
        function loadScannerLibrary() {
            console.log('üì∑ –ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞...');
            
            const qrReader = document.getElementById('qr-reader');
            if (!qrReader) return;

            qrReader.innerHTML = '<div class="scanner-loading"><div class="loading-spinner mb-2"></div><div>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞...</div></div>';
            qrReader.style.display = 'block';

            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js';
            script.onload = function() {
                console.log('‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                isScannerLoaded = true;
                qrReader.style.display = 'none';
                const startBtn = document.getElementById('startScanner');
                if (startBtn) startBtn.disabled = false;
                initializeScanner();
            };
            script.onerror = function() {
                console.error('‚ùå CDN –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                qrReader.innerHTML = '<div class="scanner-loading text-danger"><i class="bi bi-x-circle me-2"></i>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫–∞–Ω–µ—Ä. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥.</div>';
                const scannerNotSupported = document.getElementById('scannerNotSupported');
                if (scannerNotSupported) scannerNotSupported.style.display = 'block';
                const startBtn = document.getElementById('startScanner');
                if (startBtn) startBtn.disabled = true;
            };
            
            document.head.appendChild(script);
        }

        function initializeScanner() {
            if (!isScannerLoaded || !window.Html5Qrcode) {
                console.error('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                return;
            }

            Html5Qrcode.getCameras().then(devices => {
                const cameraSelect = document.getElementById('cameraSelect');
                if (!cameraSelect) return;

                cameraSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É...</option>';
                
                if (devices && devices.length) {
                    devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.id;
                        option.textContent = device.label || `–ö–∞–º–µ—Ä–∞ ${cameraSelect.children.length}`;
                        cameraSelect.appendChild(option);
                    });
                    console.log('‚úÖ –ù–∞–π–¥–µ–Ω–æ –∫–∞–º–µ—Ä:', devices.length);
                } else {
                    cameraSelect.innerHTML = '<option value="">–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
                    console.warn('‚ö†Ô∏è –ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    const startBtn = document.getElementById('startScanner');
                    if (startBtn) startBtn.disabled = true;
                }
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–º–µ—Ä:', err);
                const cameraSelect = document.getElementById('cameraSelect');
                if (cameraSelect) cameraSelect.innerHTML = '<option value="">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–∞–º</option>';
                const startBtn = document.getElementById('startScanner');
                if (startBtn) startBtn.disabled = true;
                showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–∞–º. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥.', 'warning');
            });
        }

        function startScanner() {
            if (!isScannerLoaded || !window.Html5Qrcode) {
                showAlert('–°–∫–∞–Ω–µ—Ä –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'danger');
                return;
            }

            const cameraSelect = document.getElementById('cameraSelect');
            const selectedCameraId = cameraSelect ? cameraSelect.value : '';
            
            if (!selectedCameraId) {
                showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É', 'warning');
                return;
            }

            try {
                html5QrCode = new Html5Qrcode("qr-reader");
                
                html5QrCode.start(
                    selectedCameraId,
                    {
                        fps: 10,
                        qrbox: { width: 200, height: 200 }
                    },
                    onScanSuccess,
                    onScanFailure
                ).then(() => {
                    const qrReader = document.getElementById('qr-reader');
                    const startBtn = document.getElementById('startScanner');
                    const stopBtn = document.getElementById('stopScanner');
                    
                    if (qrReader) qrReader.style.display = 'block';
                    if (startBtn) startBtn.disabled = true;
                    if (stopBtn) stopBtn.disabled = false;
                    if (cameraSelect) cameraSelect.disabled = true;
                    
                    console.log('‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ');
                }).catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞:', err);
                    showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä: ' + err.message, 'danger');
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–∞–Ω–µ—Ä–∞:', error);
                showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–∞–Ω–µ—Ä–∞: ' + error.message, 'danger');
            }
        }

        function stopScanner() {
            console.log('üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    const qrReader = document.getElementById('qr-reader');
                    const startBtn = document.getElementById('startScanner');
                    const stopBtn = document.getElementById('stopScanner');
                    const cameraSelect = document.getElementById('cameraSelect');
                    
                    if (qrReader) qrReader.style.display = 'none';
                    if (startBtn) startBtn.disabled = false;
                    if (stopBtn) stopBtn.disabled = true;
                    if (cameraSelect) cameraSelect.disabled = false;
                    
                    console.log('‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                }).catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞:', err);
                    // –í—Å–µ —Ä–∞–≤–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
                    const startBtn = document.getElementById('startScanner');
                    const stopBtn = document.getElementById('stopScanner');
                    const cameraSelect = document.getElementById('cameraSelect');
                    
                    if (startBtn) startBtn.disabled = false;
                    if (stopBtn) stopBtn.disabled = true;
                    if (cameraSelect) cameraSelect.disabled = false;
                });
            }
        }

        function onScanSuccess(decodedText) {
            console.log('üì∑ –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω –∫–æ–¥:', decodedText);
            showAlert('–ö–æ–¥ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω: ' + decodedText, 'success');
            scanProperty(decodedText);
            setTimeout(() => stopScanner(), 1000);
        }

        function onScanFailure(error) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∏–º—É—â–µ—Å—Ç–≤–∞
        async function scanProperty(inventoryNumber) {
            console.log('üîç –ü–æ–∏—Å–∫ –∏–º—É—â–µ—Å—Ç–≤–∞:', inventoryNumber);
            
            const manualScanBtn = document.getElementById('manualScan');
            if (manualScanBtn) {
                manualScanBtn.innerHTML = '<span class="loading-spinner me-1"></span>–ü–æ–∏—Å–∫...';
                manualScanBtn.disabled = true;
            }

            try {
                showAlert(`–ü–æ–∏—Å–∫ –∏–º—É—â–µ—Å—Ç–≤–∞: ${inventoryNumber}`, 'info');

                const response = await fetch('/Scan/ScanProperty', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: JSON.stringify({ 
                        inventoryNumber: inventoryNumber 
                    })
                });

                console.log('üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
                const result = await response.json();
                console.log('üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞:', result);

                if (result.success) {
                    currentPropertyId = result.property.id;
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞
                    if (result.currentUser) {
                        currentUserIsAdmin = result.currentUser.isAdmin || false;
                    }
                    determinePropertyAction(result.property);
                    showAlert('‚úÖ –ò–º—É—â–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–æ!', 'success');
                } else {
                    hideAllPropertyViews();
                    document.getElementById('noProperty').style.display = 'block';
                    showAlert(`‚ùå ${result.message}`, 'danger');
                }

            } catch (error) {
                console.error('üí• –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∏–º—É—â–µ—Å—Ç–≤–∞', 'danger');
            } finally {
                if (manualScanBtn) {
                    manualScanBtn.innerHTML = '<i class="bi bi-search"></i>';
                    manualScanBtn.disabled = false;
                }
            }
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –∏–º—É—â–µ—Å—Ç–≤–∞
        function determinePropertyAction(property) {
            console.log('üéØ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∏–º—É—â–µ—Å—Ç–≤–∞:', property);
            console.log('üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID:', currentUserId);
            console.log('üè∑Ô∏è –ò–º—É—â–µ—Å—Ç–≤–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ID:', property.assignedUserId);
            console.log('üëë –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–æ–º:', currentUserIsAdmin);
            
            hideAllPropertyViews();
            
            if (!property.assignedUserId) {
                // –ò–º—É—â–µ—Å—Ç–≤–æ —Å–≤–æ–±–æ–¥–Ω–æ (–Ω–∞ —Å–∫–ª–∞–¥–µ) - –º–æ–∂–Ω–æ –≤–∑—è—Ç—å
                console.log('‚û°Ô∏è –ü–æ–∫–∞–∑—ã–≤–∞–µ–º view –¥–ª—è –≤–∑—è—Ç–∏—è –∏–º—É—â–µ—Å—Ç–≤–∞ —Å–æ —Å–∫–ª–∞–¥–∞');
                displayTransferToUserView(property);
            } else if (property.assignedUserId === currentUserId) {
                // –ò–º—É—â–µ—Å—Ç–≤–æ —É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                console.log('üëÄ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º view –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–∏–º—É—â–µ—Å—Ç–≤–æ —É–∂–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)');
                displayPropertyWithCurrentUserView(property);
            } else {
                // –ò–º—É—â–µ—Å—Ç–≤–æ —É –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (currentUserIsAdmin) {
                    // –ê–î–ú–ò–ù –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—è—Ç—å –æ—Ç –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–∫–ª–∞–¥
                    console.log('‚¨ÖÔ∏è –ü–æ–∫–∞–∑—ã–≤–∞–µ–º view –¥–ª—è –ø—Ä–∏–µ–º–∞ –Ω–∞ —Å–∫–ª–∞–¥ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    displayReturnToWarehouseView(property);
                } else {
                    // –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞–±—Ä–∞—Ç—å —É –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    console.log('‚û°Ô∏è –ü–æ–∫–∞–∑—ã–≤–∞–µ–º view –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    displayTransferToUserView(property);
                }
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å view –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∏–º—É—â–µ—Å—Ç–≤–∞
        function displayTransferToUserView(property) {
            console.log('üìã –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∏–º—É—â–µ—Å—Ç–≤–∞');
            const transferPropertyDetails = document.getElementById('transferPropertyDetails');
            if (transferPropertyDetails) {
                const fromUser = property.assignedUserId ? property.currentUser : '–°–∫–ª–∞–¥';
                const fromLocation = property.assignedUserId ? property.location : '–°–∫–ª–∞–¥';
                const toLocation = currentUserLocation;
                
                transferPropertyDetails.innerHTML = `
                    <div class="property-detail">
                        <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${escapeHtml(property.name)}
                    </div>
                    <div class="property-detail">
                        <strong>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π ‚Ññ:</strong> ${escapeHtml(property.inventoryNumber)}
                    </div>
                    <div class="property-detail">
                        <strong>–¢–∏–ø:</strong> ${escapeHtml(property.propertyType || '–ù–µ —É–∫–∞–∑–∞–Ω')}
                    </div>
                    <div class="property-detail">
                        <strong>–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> ${escapeHtml(fromUser)}
                    </div>
                    <div class="property-detail">
                        <strong>–° –ª–æ–∫–∞—Ü–∏–∏:</strong> ${escapeHtml(fromLocation)}
                    </div>
                    <div class="property-detail">
                        <strong>–ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:</strong> ${escapeHtml(currentUserName)}
                    </div>
                    <div class="property-detail">
                        <strong>–ù–∞ –ª–æ–∫–∞—Ü–∏—é:</strong> ${escapeHtml(toLocation)} <span class="text-success">(–±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞)</span>
                    </div>
                `;
            }
            document.getElementById('transferToUser').style.display = 'block';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å view –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ —Å–∫–ª–∞–¥ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
        function displayReturnToWarehouseView(property) {
            console.log('üìã –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø—Ä–∏–µ–º–∞ –Ω–∞ —Å–∫–ª–∞–¥');
            const returnPropertyDetails = document.getElementById('returnPropertyDetails');
            if (returnPropertyDetails) {
                const fromUser = property.assignedUserId ? property.currentUser : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const fromLocation = property.assignedUserId ? property.location : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                
                returnPropertyDetails.innerHTML = `
                    <div class="property-detail">
                        <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${escapeHtml(property.name)}
                    </div>
                    <div class="property-detail">
                        <strong>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π ‚Ññ:</strong> ${escapeHtml(property.inventoryNumber)}
                    </div>
                    <div class="property-detail">
                        <strong>–¢–∏–ø:</strong> ${escapeHtml(property.propertyType || '–ù–µ —É–∫–∞–∑–∞–Ω')}
                    </div>
                    <div class="property-detail">
                        <strong>–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> ${escapeHtml(fromUser)}
                    </div>
                    <div class="property-detail">
                        <strong>–° –ª–æ–∫–∞—Ü–∏–∏:</strong> ${escapeHtml(fromLocation)}
                    </div>
                    <div class="property-detail">
                        <strong>–ù–∞ —Å–∫–ª–∞–¥:</strong> –ü—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –≤—ã (${escapeHtml(currentUserName)})
                    </div>
                    <div class="property-detail">
                        <strong>–õ–æ–∫–∞—Ü–∏—è —Å–∫–ª–∞–¥–∞:</strong> ${escapeHtml(currentUserLocation)} <span class="text-success">(–±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞)</span>
                    </div>
                `;
            }
            document.getElementById('returnToWarehouse').style.display = 'block';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å view –∫–æ–≥–¥–∞ –∏–º—É—â–µ—Å—Ç–≤–æ —É–∂–µ —É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function displayPropertyWithCurrentUserView(property) {
            console.log('üìã –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∏–º—É—â–µ—Å—Ç–≤–∞ —É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            const currentUserPropertyDetails = document.getElementById('currentUserPropertyDetails');
            if (currentUserPropertyDetails) {
                currentUserPropertyDetails.innerHTML = `
                    <div class="property-detail">
                        <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${escapeHtml(property.name)}
                    </div>
                    <div class="property-detail">
                        <strong>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π ‚Ññ:</strong> ${escapeHtml(property.inventoryNumber)}
                    </div>
                    <div class="property-detail">
                        <strong>–¢–∏–ø:</strong> ${escapeHtml(property.propertyType || '–ù–µ —É–∫–∞–∑–∞–Ω')}
                    </div>
                    <div class="property-detail">
                        <strong>–õ–æ–∫–∞—Ü–∏—è:</strong> ${escapeHtml(property.location || '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}
                    </div>
                    <div class="property-detail">
                        <strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="badge bg-success">–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ –∑–∞ –≤–∞–º–∏</span>
                    </div>
                `;
            }
            document.getElementById('propertyWithCurrentUser').style.display = 'block';
        }

        // –°–∫—Ä—ã—Ç—å –≤—Å–µ view –∏–º—É—â–µ—Å—Ç–≤–∞
        function hideAllPropertyViews() {
            console.log('üëª –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ view –∏–º—É—â–µ—Å—Ç–≤–∞');
            const views = [
                'transferToUser', 'returnToWarehouse', 'propertyWithCurrentUser',
                'noProperty', 'scannerNotSupported'
            ];
            views.forEach(view => {
                const element = document.getElementById(view);
                if (element) element.style.display = 'none';
            });
        }

        // –ü—Ä–∏–Ω—è—Ç—å –∏–º—É—â–µ—Å—Ç–≤–æ (–æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–æ —Å–∫–ª–∞–¥–∞)
        async function transferToUser() {
            console.log('‚úÖ –í–∑—è—Ç–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ, ID:', currentPropertyId);
            
            if (!currentPropertyId) {
                showAlert('–ò–º—É—â–µ—Å—Ç–≤–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ', 'danger');
                return;
            }
            
            try {
                const response = await fetch('/Scan/TransferToUser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: JSON.stringify({
                        propertyId: currentPropertyId
                    })
                });
                
                const result = await response.json();
                console.log('üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–¥–∞—á–∏:', result);
                
                if (result.success) {
                    showAlert('‚úÖ ' + result.message, 'success');
                    hideAllPropertyViews();
                    document.getElementById('manualInput').value = '';
                } else {
                    showAlert(`‚ùå ${result.message}`, 'danger');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –∏–º—É—â–µ—Å—Ç–≤–∞:', error);
                showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –∏–º—É—â–µ—Å—Ç–≤–∞', 'danger');
            }
        }

        // –í–µ—Ä–Ω—É—Ç—å –∏–º—É—â–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
        async function returnToWarehouse() {
            console.log('üè≠ –ü—Ä–∏–µ–º –∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–∞ —Å–∫–ª–∞–¥, ID:', currentPropertyId);
            
            if (!currentPropertyId) {
                showAlert('–ò–º—É—â–µ—Å—Ç–≤–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ', 'danger');
                return;
            }
            
            try {
                const response = await fetch('/Scan/ReturnToWarehouse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: JSON.stringify({
                        propertyId: currentPropertyId
                    })
                });
                
                const result = await response.json();
                console.log('üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏–µ–º–∞ –Ω–∞ —Å–∫–ª–∞–¥:', result);
                
                if (result.success) {
                    showAlert('üè≠ ' + result.message, 'success');
                    hideAllPropertyViews();
                    document.getElementById('manualInput').value = '';
                } else {
                    showAlert(`‚ùå ${result.message}`, 'danger');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–µ–º–∞ –Ω–∞ —Å–∫–ª–∞–¥:', error);
                showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–µ–º–µ –∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–∞ —Å–∫–ª–∞–¥', 'danger');
            }
        }

        function manualScan() {
            const manualInput = document.getElementById('manualInput');
            const inventoryNumber = manualInput?.value.trim();
            
            if (!inventoryNumber) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –Ω–æ–º–µ—Ä', 'warning');
                return;
            }
            
            console.log('üñ±Ô∏è –†—É—á–Ω–æ–π –ø–æ–∏—Å–∫:', inventoryNumber);
            scanProperty(inventoryNumber);
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function getAntiForgeryToken() {
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            if (!token) {
                console.error('‚ùå Anti forgery token –Ω–µ –Ω–∞–π–¥–µ–Ω!');
            }
            return token || '';
        }

        function showAlert(message, type) {
            // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => {
                if (alert.parentNode) {
                    alert.remove();
                }
            });
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container-fluid');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
            }
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
            
            getCurrentUser().then(() => {
                console.log('üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π...');
                
                // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
                document.getElementById('startScanner').addEventListener('click', startScanner);
                document.getElementById('stopScanner').addEventListener('click', stopScanner);
                document.getElementById('manualScan').addEventListener('click', manualScan);
                document.getElementById('confirmTransferToUser').addEventListener('click', transferToUser);
                document.getElementById('confirmReturnToWarehouse').addEventListener('click', returnToWarehouse);
                
                document.getElementById('manualInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        console.log('‚å®Ô∏è –ù–∞–∂–∞—Ç–∞ –∫–ª–∞–≤–∏—à–∞ Enter');
                        manualScan();
                    }
                });

                loadScannerLibrary();
                
                console.log('üéâ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
            });
        });
    </script>
}